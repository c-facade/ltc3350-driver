From 4698435b4905a6c8a84f62581551ac5ad518ad01 Mon Sep 17 00:00:00 2001
From: OpenEmbedded <oe.patch@oe>
Date: Thu, 1 Aug 2024 10:40:00 +0200
Subject: [PATCH] documentation

---
 .../devicetree/bindings/hwmon/ltc3350.txt     | 42 -----------
 .../devicetree/bindings/hwmon/ltc3350.yaml    | 74 +++++++++++++++++++
 Documentation/hwmon/ltc3350.rst               | 68 +++++++++++++++--
 3 files changed, 137 insertions(+), 47 deletions(-)
 delete mode 100644 Documentation/devicetree/bindings/hwmon/ltc3350.txt
 create mode 100644 Documentation/devicetree/bindings/hwmon/ltc3350.yaml

diff --git a/Documentation/devicetree/bindings/hwmon/ltc3350.txt b/Documentation/devicetree/bindings/hwmon/ltc3350.txt
deleted file mode 100644
index 5649813b149c..000000000000
--- a/Documentation/devicetree/bindings/hwmon/ltc3350.txt
+++ /dev/null
@@ -1,42 +0,0 @@
-ltc3350: Linear Technology LTC3350 High Current Supercapacitor Backup Controller and System Monitor
-
-Required properties:
-- compatible: Must be "ltc3350"
-- reg: I2C address
-
-Optional properties:
- - capacitor-overvoltage-level:
-		This is an alarm threshold for each individual capacitor in the stack. The value is expressed in 185 microvolts per LSB.
- - esr-high-level:
-		This is an alarm threshold for the measured stack ESR. It is expressed as RSNSC/64 per LSB.
- - capacitance-low-level:
-		This is an alarm threshold for measured stack capacitance. It is expressed as 336µF • RT/RTST per LSB for large value capacitor stacks.
- - cap-esr-measurement-period
-		This sets the period for repeated ESR and capacitance measurements. Each unit corresponds to 10 seconds. If not specified, periodic measurements will be disabled.
- - cap-esr-initial-measurements:
-		The number of measurements after initial power-up. If not specified, there will be *insert number* every *hour?*. If zero, initial measurements will be disabled.
-
-If a threshold is unset, the corresponding alert will be disabled.
-
-In order to receive SMBUS alerts, CONFIG_I2C_SMBUS and CONFIG_OF modules must be enabled. The parent I2C device node must declare the 'smbus_alert' interrupt on the appropriate interrupt line.
-
-Example:
-
-&i2c3 {
-	/* i2c properties */
-	interrupts-extended = <&gic GIC_SPI 37 IRQ_TYPE_LEVEL_HIGH>,
-		<&gpio1 10 IRQ_TYPE_LEVEL_LOW>;
-	interrupt-names = "irq", "smbus_alert";
-
-	ltc3350: ltc3350@09 {
-		compatible = "ltc3350";
-		reg = <0x09>;
-
-		capacitor-overvoltage-level = <12534>; // 2300 mV
-		maximum-temperature = <12907>; // 110 C
-		esr-high-level = <192>; // 15 mR
-		capacitance-low-level = <249>; // 60 F
-		cap-esr-measurement-period = <12>;
-		cap-esr-initial-measurements = <10>;
-	}
-};
diff --git a/Documentation/devicetree/bindings/hwmon/ltc3350.yaml b/Documentation/devicetree/bindings/hwmon/ltc3350.yaml
new file mode 100644
index 000000000000..5e8ca194fa9b
--- /dev/null
+++ b/Documentation/devicetree/bindings/hwmon/ltc3350.yaml
@@ -0,0 +1,74 @@
+%YAML 1.2
+---
+$id: http://devicetree.org/schemas/hwmon/lltc,ltc4151.yaml#
+$schema: http://devicetree.org/meta-schemas/core.yaml#
+
+title: Linear Technology LTC3350 High Current Supercapacitor Backup Controller and System Monitor
+
+maintainers:
+  - Francesca Pinna <francecipinna@gmail.com>
+
+description:
+  Analog Devices LTC3350 High Current Supercapacitor Backup Controller and System Monitor.
+  https://www.analog.com/en/products/ltc3350.html?doc=LTC3350.pdf
+  
+  The I2C SMBus port allows communication, and the SMBALERT pin allows the use of the SMBus alert response protocol.
+  In order to receive SMBus alerts, CONFIG_I2C_SMBUS and CONFIG_OF modules must be enabled. The parent I2C device node must declare the 'smbus_alert' interrupt on the appropriate interrupt line.
+  
+  If a threshold is unset, the corresponding alert will be disabled.
+
+properties:
+  compatible:
+    const: ltc3350
+
+  reg:
+    maxItems: 1
+    description:
+      I2C address
+
+	capacitor-overvoltage-level:
+		description:
+			This is an alarm threshold for each individual capacitor in the stack. The value is expressed in 185 microvolts per LSB.
+  max-temperature:
+    description:
+      This is an alarm threshold for the die temperature. It is expressed as Temperature = 0.028°C per LSB – 251.4°C.
+	esr-high-level:
+		description:
+			This is an alarm threshold for the measured stack ESR. It is expressed as RSNSC/64 per LSB.
+	capacitance-low-level:
+		description:
+			This is an alarm threshold for measured stack capacitance. It is expressed as 336µF • RT/RTST per LSB for large value capacitor stacks.
+	cap-esr-measurement-period:
+		description:
+			This sets the period for repeated ESR and capacitance measurements. Each unit corresponds to 10 seconds. If not specified, periodic measurements will be disabled.
+	cap-esr-initial-measurements:
+		description:
+			The number of measurements after initial power-up. If not specified, there will be one test per hour for 72 hours. If zero, initial measurements will be disabled.
+    default:
+      72
+
+required:
+  - compatible
+  - reg
+
+examples:
+
+  - |
+    i2c {
+        interrupts-extended = <&gic GIC_SPI 37 IRQ_TYPE_LEVEL_HIGH>,
+          <&gpio1 10 IRQ_TYPE_LEVEL_LOW>;
+        interrupt-names = "irq", "smbus_alert";
+
+        ltc3350: ltc3350@09 {
+          compatible = "ltc3350";
+          reg = <0x09>;
+
+          capacitor-overvoltage-level = <12534>; // 2300 mV
+          maximum-temperature = <12907>; // 110 C
+          esr-high-level = <192>; // 15 mR
+          capacitance-low-level = <249>; // 60 F
+          cap-esr-measurement-period = <12>;
+          cap-esr-initial-measurements = <10>;
+        };
+    };
+...
diff --git a/Documentation/hwmon/ltc3350.rst b/Documentation/hwmon/ltc3350.rst
index 77b136b3ef07..767b750ac36e 100644
--- a/Documentation/hwmon/ltc3350.rst
+++ b/Documentation/hwmon/ltc3350.rst
@@ -18,11 +18,21 @@ Author: Francesca Pinna
 Description
 -----------
 
-The LTC3350 is a backup power controller that can charge
-and monitor a series stack of one to four supercapacitors.
+This driver implements support for the Analog Devices LTC3350 High Current Supercapacitor Backup Controller and System Monitor.
+
+The LTC3350 monitors system voltages, currents, stack capacitance and stack ESR.
+It has an integreted analog-to-digital converter(ADC), and its results are stored in registers accessible via the I2C/SMBus port.
+The result of the ADC conversion is stores in a 16-bit register as a signed, two's complement number. The lower two bits of the number are sub-bits.
+
+The ADC Least Significant Bit units are not reported in standard units of measurement. This driver does not convert values, both to expose more precise measurements, and because some values depend on the specific application's resistance.
+The sysfs entries are expressed as read from the registers, except for the conversion to signed integers.
+
+It is possible to set alarms, which are all disabled by default. The limit checking function will periodically check each measured value against the I2C programmable limits, so it is not necessary to poll the I2C for measurement data.
+If a measured parameter goes outside of the programmed level of an enabled limit, the associated bit in the alarm_reg register is set high and the SMBALERT pin is pulled low. This driver makes use of the I2C_SMBUS module to handle SMBus alerts.
+Once the interrupt is declared in the device tree with the name "smbus_alert", the function in `i2c/i2c-core-smbus.c` will register a new ARA device. The I2C_SMBUS module defines an interrupt handler which schedules the execution of the `alert()` function of this driver.
+
+Once the LTC3350 has responded to an SMBus ARA the SMBALERT pin is released. So, the alert() function will not be called until another limit is exceeded. To reset a limit, it must be cleared by writing a one to the respective bit in the clr_alarms register.
 
-The LTC3350 monitors system voltages, currents, stack capacitance and stack ESR which can all be read over the I2C/SMBus.
-The device can trigger a SMBus alert through the SMBALERT pin.
 
 Usage Notes
 -----------
@@ -40,4 +50,52 @@ This is assuming that i2c numbering starts from zero.
 Sysfs entries
 -------------
 
-TODO describe the system and the sysfs entries.
+The sysfs entries directly correspond to the LTC3350 registers
+
+============================ ======
+===================================
+Name    Perm  Description
+============================ ======
+===================================
+clr_alarms		RW	Clear alarms register
+msk_alarms		RW	Enable/mask alarms register
+msk_mon_status		RW	Enable/mask monitor status alerts
+cap_esr_per		RW	Capacitance/ESR measurement period
+vcapfb_dac		RW	 VCAP voltage reference DAC setting
+vshunt		RW	 Capacitor shunt voltage setting
+cap_uv_lvl		RW	Capacitor Undervoltage Level
+cap_ov_lvl		RW	Capacitor Overvoltage Level
+gpi_uv_lvl		RW	General Purpose Input Undervoltage Level
+gpi_ov_lvl		RW	General Purpose Input Overvoltage Level
+vin_uv_lvl		RW	General Purpose Input Overvoltage Level
+vin_ov_lvl		RW	General Purpose Input Overvoltage Level
+vcap_uv_lvl		RW	VCAP Undervoltage Level
+vcap_ov_lvl		RW	VCAP Overvoltage Level
+vout_uv_lvl		RW	VOUT Undervoltage Level
+vout_ov_lvl		RW	VOUT Overvoltage Level
+iin_oc_lvl		RW	Input Overcurrent Level
+ichg_uc_lvl		RW	Charge Undercurrent Level
+dtemp_cold_lvl		RW	Charge Undercurrent Level
+dtemp_hot_lvl		RW	Die Temperature Hot Level
+esr_hi_lvl		RW	ESR High Level
+cap_lo_lvl		RW	Capacitance Low Level
+ctl_reg		RW	Control register 
+num_caps		RO	Number of capacitors configured 
+chrg_status		RO	Charger status register 
+mon_status		RO	Monitor status register
+alarm_reg		RO	Active alarms register
+meas_cap		RO	Measured capacitance value 
+meas_esr		RO	Measured ESR value 
+meas_vcap1		RO	Measured capacitor one voltage
+meas_vcap2		RO	Measured capacitor two voltage
+meas_vcap3		RO	Measured capacitor three voltage
+meas_vcap4		RO	Measured capacitor four voltage
+meas_gpi		RO	Measured GPI pin voltage
+meas_vin		RO	Measured VIN voltage
+meas_vcap		RO	Measured VCAP voltage
+meas_vout		RO	Measured VOUT voltage
+meas_iin		RO	Measured IIN current
+meas_ichg		RO	Measured ICHG current
+meas_dtemp		RO	Measured die temperature
+===================================== =======
+=============================================
-- 
2.34.1

